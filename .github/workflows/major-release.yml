name: Major Release - New Features

on:
  push:
    tags:
      - 'v[0-9]+.0.0'  # Matches v2.0.0, v3.0.0, etc. (major versions)
  workflow_dispatch:
    inputs:
      version:
        description: 'Major version number (e.g., 2.0.0, 3.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes and breaking changes'
        required: false
        type: string

jobs:
  validate-major-version:
    name: Validate Major Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_major: ${{ steps.check_type.outputs.is_major }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Validate major version format
        id: check_type
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Check if this is a major release (X.0.0)
          if [ "$MINOR" == "0" ] && [ "$PATCH" == "0" ]; then
            echo "is_major=true" >> $GITHUB_OUTPUT
            echo "‚úÖ This is a MAJOR release"
          else
            echo "is_major=false" >> $GITHUB_OUTPUT
            echo "‚ùå This is NOT a major release (must be X.0.0 format)"
            exit 1
          fi

  create-major-release:
    name: Create Major Release
    runs-on: ubuntu-latest
    needs: validate-major-version
    if: needs.validate-major-version.outputs.is_major == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update version in code
        run: |
          VERSION="${{ needs.validate-major-version.outputs.version }}"
          sed -i "s/APP_VERSION = \".*\"/APP_VERSION = \"$VERSION\"/" app/routers/admin.py

      - name: Commit version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app/routers/admin.py
          git diff --staged --quiet || git commit -m "üöÄ Major release: Bump version to ${{ needs.validate-major-version.outputs.version }}"
          git push origin main || true

      - name: Get previous version
        id: prev_version
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v0.0.0")
          echo "previous=${PREV_TAG#v}" >> $GITHUB_OUTPUT
          echo "Previous version: ${PREV_TAG#v}"

      - name: Generate comprehensive changelog
        id: changelog
        run: |
          PREV_TAG="v${{ steps.prev_version.outputs.previous }}"

          # Features
          FEATURES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges | grep -E "(feat|feature|add)" -i || echo "")

          # Bug fixes
          FIXES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges | grep -E "(fix|bug)" -i || echo "")

          # Breaking changes
          BREAKING=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges | grep -E "(breaking|break)" -i || echo "")

          # Security updates
          SECURITY=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges | grep -E "(security|cve)" -i || echo "")

          # Build changelog
          CHANGELOG="### üéâ New Features\n"
          if [ -n "$FEATURES" ]; then
            CHANGELOG+="$FEATURES\n"
          else
            CHANGELOG+="- Multiple new features and improvements\n"
          fi

          CHANGELOG+="\n### üêõ Bug Fixes\n"
          if [ -n "$FIXES" ]; then
            CHANGELOG+="$FIXES\n"
          else
            CHANGELOG+="- Various bug fixes and stability improvements\n"
          fi

          if [ -n "$BREAKING" ]; then
            CHANGELOG+="\n### ‚ö†Ô∏è BREAKING CHANGES\n$BREAKING\n"
          fi

          if [ -n "$SECURITY" ]; then
            CHANGELOG+="\n### üîí Security Updates\n$SECURITY\n"
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Major Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.validate-major-version.outputs.version }}
          release_name: üöÄ v${{ needs.validate-major-version.outputs.version }} - Major Release
          body: |
            # üöÄ Major Release v${{ needs.validate-major-version.outputs.version }}

            **Previous Version:** ${{ steps.prev_version.outputs.previous }}
            **Release Date:** ${{ github.event.repository.updated_at }}

            ---

            ${{ steps.changelog.outputs.changelog }}

            ---

            ## üìã Installation & Update

            ### ‚ö†Ô∏è IMPORTANT: Major Release Notes
            This is a **major version** release which may contain:
            - New features and functionality
            - Breaking changes to APIs or configuration
            - Database schema changes
            - Updated dependencies

            **Recommended Steps:**
            1. ‚úÖ Create a full backup before updating
            2. ‚úÖ Review breaking changes above
            3. ‚úÖ Test in staging environment first
            4. ‚úÖ Plan maintenance window for production

            ### Installation Methods

            **Method 1: Admin Portal**
            1. Log in to Admin Portal at `/admin-login.html`
            2. Navigate to Dashboard ‚Üí Application Updates
            3. Click "Check for Updates"
            4. **Review the update information carefully**
            5. Click "Install Update" (automatic backup will be created)

            **Method 2: Manual Update**
            ```bash
            # IMPORTANT: Create backup first!
            docker-compose exec web python -c "from app.routers.admin import create_backup; import asyncio; asyncio.run(create_backup())"

            # Pull latest code
            git fetch origin main
            git checkout main
            git pull origin main

            # Rebuild and restart
            docker-compose down
            docker-compose up -d --build

            # Migrations run automatically on startup
            ```

            **Method 3: Docker Image**
            ```bash
            # Pull latest images
            docker-compose pull

            # Restart with new images
            docker-compose down
            docker-compose up -d
            ```

            ---

            ## üîê Safety & Rollback

            ### Automatic Safety Features
            - ‚úÖ Snapshot backup created before update
            - ‚úÖ Database migrations with validation
            - ‚úÖ Graceful restart process
            - ‚úÖ Zero data loss guarantee

            ### Rollback Procedure
            If you encounter issues after updating:

            1. **Via Admin Portal:**
               - Go to Backups section
               - Find the snapshot backup (created before update)
               - Click "Restore"

            2. **Via Command Line:**
               ```bash
               # List snapshots
               ls -lh backups/snapshot_before_update*

               # Restore from snapshot
               docker-compose exec -T db psql -U postgres -d familytree < backups/snapshot_before_update_TIMESTAMP.sql

               # Restart
               docker-compose restart web
               ```

            ---

            ## üìä System Requirements

            - Docker 20.10+ and Docker Compose 2.0+
            - PostgreSQL 14+
            - Python 3.11+
            - Minimum 2GB RAM
            - 10GB disk space

            ---

            ## üìñ Documentation

            - [Update Guide](UPDATE_GUIDE.md)
            - [Quick Update Instructions](.github/UPDATE_INSTRUCTIONS.md)
            - [Security Compliance](SECURITY_COMPLIANCE.md)

            ---

            ## üÜò Support

            - Report issues: [GitHub Issues](https://github.com/YOUR_ORG/family-tree-app/issues)
            - Review logs: Admin Portal ‚Üí Logs
            - Check backups: Admin Portal ‚Üí Backups

            ---

            **Release Type:** üöÄ Major Release
            **Upgrade Path:** ${{ steps.prev_version.outputs.previous }} ‚Üí ${{ needs.validate-major-version.outputs.version }}
            **Estimated Downtime:** ~1-2 minutes

            ${{ github.event.inputs.release_notes }}
          draft: false
          prerelease: false

  build-and-tag-docker:
    name: Build and Tag Docker Images
    runs-on: ubuntu-latest
    needs: [validate-major-version, create-major-release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: ${{ secrets.DOCKER_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract major version
        id: major
        run: |
          VERSION="${{ needs.validate-major-version.outputs.version }}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          echo "major=$MAJOR" >> $GITHUB_OUTPUT

      - name: Build and push with multiple tags
        if: ${{ secrets.DOCKER_USERNAME != '' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/family-tree-app:latest
            ${{ secrets.DOCKER_USERNAME }}/family-tree-app:v${{ needs.validate-major-version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/family-tree-app:v${{ steps.major.outputs.major }}
            ${{ secrets.DOCKER_USERNAME }}/family-tree-app:major-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build only (no Docker Hub)
        if: ${{ secrets.DOCKER_USERNAME == '' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: |
            family-tree-app:v${{ needs.validate-major-version.outputs.version }}
            family-tree-app:v${{ steps.major.outputs.major }}

  notify-major-release:
    name: Notify Major Release
    runs-on: ubuntu-latest
    needs: [validate-major-version, create-major-release, build-and-tag-docker]
    steps:
      - name: Success notification
        run: |
          echo "üöÄ Major release v${{ needs.validate-major-version.outputs.version }} completed successfully!"
          echo "Docker images tagged and pushed"
          echo "GitHub release created"
          echo "Ready for deployment"
