<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="2.2.0">
    <title>Family Tree App v2.2.0</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="bg-light">
    <!-- Authentication Section -->
    <div id="auth-container" class="auth-container">
        <div class="auth-box">
            <h1>Family Tree App</h1>

            <!-- Login Form -->
            <div id="login-form" class="auth-form">
                <h2>Login</h2>
                <form onsubmit="handleLogin(event)">
                    <input type="text" id="login-username" placeholder="Username" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
                <p>Don't have an account? <a href="#" onclick="showRegister()">Register here</a></p>
                <div id="login-error" class="error-message"></div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="auth-form" style="display: none;">
                <h2>Register</h2>
                <form onsubmit="handleRegister(event)">
                    <input type="text" id="register-username" placeholder="Username" required>
                    <input type="email" id="register-email" placeholder="Email" required>
                    <input type="password" id="register-password" placeholder="Password" required>
                    <button type="submit">Register</button>
                </form>
                <p>Already have an account? <a href="#" onclick="showLogin()">Login here</a></p>
                <div id="register-error" class="error-message"></div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <h1>Family Tree</h1>
                <div class="tree-selector-header">
                    <select id="family-tree-select" onchange="switchFamilyTree(this.value)" class="tree-dropdown">
                        <option value="">Loading trees...</option>
                    </select>
                    <button onclick="showTreeManagementModal()" class="btn-icon" title="Manage Trees">
                        <i class="bi bi-gear"></i>
                    </button>
                    <button onclick="showPendingShares()" class="btn-icon" title="Pending Shares" id="shares-btn" style="position: relative;">
                        <i class="bi bi-share"></i>
                        <span id="pending-shares-badge" class="badge-notification" style="display: none;">0</span>
                    </button>
                </div>
            </div>
            <div class="header-actions">
                <span id="username-display" class="username-link" onclick="showAccountSettings()"></span>
                <button onclick="logout()" class="btn-logout">Logout</button>
            </div>
        </header>

        <!-- Controls -->
        <div class="controls">
            <div class="view-selector">
                <label for="tree-view-select">View:</label>
                <select id="tree-view-select" onchange="switchTreeView(this.value)">
                    <option value="">Default View</option>
                </select>
                <button onclick="showManageViewsModal()" class="btn-icon" title="Manage Views">⚙</button>
            </div>
            <button onclick="showAddMemberForm()" class="btn-primary">Add Family Member</button>
            <button onclick="resetTreeView()" class="btn-secondary">Reset View</button>

            <!-- Highlight Descendants Feature -->
            <div class="highlight-controls" style="display: inline-flex; align-items: center; gap: 10px; margin-left: 10px; padding: 5px 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                <label style="margin: 0; font-weight: 500;">
                    <input type="checkbox" id="highlight-mode" onchange="toggleHighlightMode(this.checked)" style="margin-right: 5px;">
                    Highlight Descendants
                </label>
                <select id="highlight-person-select" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ced4da;" disabled onchange="highlightDescendants(this.value)">
                    <option value="">Select person...</option>
                </select>
                <button onclick="exportHighlightedPDF()" class="btn-icon" title="Export Highlighted PDF" id="export-highlight-pdf" disabled><i class="bi bi-file-pdf"></i></button>
                <button onclick="exportHighlightedJPEG()" class="btn-icon" title="Export Highlighted JPEG" id="export-highlight-jpeg" disabled><i class="bi bi-file-image"></i></button>
            </div>

            <button onclick="exportToCSV()" class="btn-secondary">Export CSV</button>
            <button onclick="showImportCSVModal()" class="btn-secondary">Import CSV</button>
            <button onclick="exportToPDF()" class="btn-secondary">Export PDF</button>
            <button onclick="exportToJPEG()" class="btn-secondary">Export JPEG</button>
        </div>

        <!-- Family Summary -->
        <div id="family-summary" class="family-summary">
            <h3>Family Tree Summary</h3>
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-members">0</div>
                    <div class="stat-label">Total Members</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="male-count">0</div>
                    <div class="stat-label">Male</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="female-count">0</div>
                    <div class="stat-label">Female</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="generations-count">0</div>
                    <div class="stat-label">Generations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="living-count">0</div>
                    <div class="stat-label">Living</div>
                </div>
            </div>
        </div>

        <!-- Family Tree Visualization -->
        <div id="tree-container" class="tree-container">
            <svg id="tree-svg" width="100%" height="600"></svg>
            <div class="zoom-controls">
                <button onclick="zoomIn()" class="zoom-btn" title="Zoom In">+</button>
                <button onclick="zoomOut()" class="zoom-btn" title="Zoom Out">−</button>
                <button onclick="resetZoom()" class="zoom-btn" title="Reset Zoom">⟲</button>
            </div>
            <!-- Hover Tooltip -->
            <div id="node-tooltip" class="node-tooltip"></div>
            <!-- Context Menu -->
            <div id="context-menu" class="context-menu" style="display: none;">
                <div class="context-menu-item" onclick="contextMenuHighlightDescendants()">
                    <i class="bi bi-diagram-3"></i> Highlight Descendants
                </div>
                <div class="context-menu-item" onclick="contextMenuViewDetails()">
                    <i class="bi bi-person-circle"></i> View Details
                </div>
                <div class="context-menu-item" onclick="contextMenuEditMember()">
                    <i class="bi bi-pencil"></i> Edit Member
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" onclick="contextMenuExportJPEG()">
                    <i class="bi bi-file-earmark-image"></i> Export as JPEG
                </div>
                <div class="context-menu-item" onclick="contextMenuExportPDF()">
                    <i class="bi bi-file-earmark-pdf"></i> Export as PDF
                </div>
                <div class="context-menu-item" onclick="contextMenuExportCSV()">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Export as CSV
                </div>
            </div>
        </div>

        <!-- Member Details Panel -->
        <div id="details-panel" class="details-panel" style="display: none;">
            <div class="panel-header">
                <h3>Member Details</h3>
                <button onclick="closeDetailsPanel()" class="btn-close">&times;</button>
            </div>
            <div id="member-details" class="panel-content"></div>
        </div>

        <!-- Add/Edit Member Modal -->
        <div id="member-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Add Family Member</h3>
                    <button onclick="closeMemberModal()" class="btn-close">&times;</button>
                </div>
                <form id="member-form" onsubmit="handleMemberSubmit(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="first-name" required>
                        </div>
                        <div class="form-group">
                            <label>Middle Name</label>
                            <input type="text" id="middle-name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="last-name" required>
                        </div>
                        <div class="form-group">
                            <label>Nickname</label>
                            <input type="text" id="nickname">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="gender">
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Occupation</label>
                            <input type="text" id="occupation">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Birth Date</label>
                            <input type="date" id="birth-date">
                        </div>
                        <div class="form-group">
                            <label>Death Date</label>
                            <input type="date" id="death-date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Birth Place</label>
                        <input type="text" id="birth-place">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Current Location</label>
                            <input type="text" id="location" placeholder="City, State">
                        </div>
                        <div class="form-group">
                            <label>Country</label>
                            <input type="text" id="country">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Biography</label>
                        <textarea id="bio" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Previous Partners</label>
                        <input type="text" id="previous-partners" placeholder="Ex-spouse names (comma separated)">
                    </div>
                    <div class="form-group">
                        <label>Profile Picture</label>
                        <input type="file" id="profile-picture" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp">
                        <small style="color: #666; font-size: 12px;">Max file size: 5MB. Supported formats: JPEG, PNG, GIF, WebP</small>
                        <div id="photo-preview" style="margin-top: 10px; display: none;">
                            <img id="photo-preview-img" src="" style="max-width: 150px; max-height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid #667eea;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Facebook</label>
                            <input type="url" id="social-facebook" placeholder="https://facebook.com/...">
                        </div>
                        <div class="form-group">
                            <label>Instagram</label>
                            <input type="url" id="social-instagram" placeholder="https://instagram.com/...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Twitter/X</label>
                            <input type="url" id="social-twitter" placeholder="https://twitter.com/...">
                        </div>
                        <div class="form-group">
                            <label>LinkedIn</label>
                            <input type="url" id="social-linkedin" placeholder="https://linkedin.com/in/...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Father</label>
                            <select id="father-id">
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Mother</label>
                            <select id="mother-id">
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeMemberModal()" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div id="account-settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Account Settings</h2>
                <button class="modal-close" onclick="closeAccountSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Update Email</h3>
                    <form onsubmit="updateEmail(event)">
                        <div class="form-group">
                            <label>New Email</label>
                            <input type="email" id="new-email" required>
                        </div>
                        <div id="email-error" class="error-message"></div>
                        <button type="submit" class="btn-primary">Update Email</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>Change Password</h3>
                    <form onsubmit="updatePassword(event)">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" id="current-password" required>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="new-password" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" id="confirm-password" required minlength="6">
                        </div>
                        <div id="password-error" class="error-message"></div>
                        <button type="submit" class="btn-primary">Change Password</button>
                    </form>
                </div>

                <div class="settings-section danger-zone">
                    <h3>Danger Zone</h3>
                    <p>Deleting your account is permanent and cannot be undone.</p>
                    <form onsubmit="deleteAccount(event)">
                        <div class="form-group">
                            <label>Enter your password to confirm deletion</label>
                            <input type="password" id="delete-password" required>
                        </div>
                        <div id="delete-error" class="error-message"></div>
                        <button type="submit" class="btn-delete">Delete Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Views Modal -->
    <div id="manage-views-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Tree Views</h3>
                <button onclick="closeManageViewsModal()" class="btn-close">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <button onclick="showCreateViewForm()" class="btn-primary">Create New View</button>
                    <button onclick="saveCurrentView()" class="btn-secondary">Save Current View</button>
                </div>

                <div id="views-list"></div>

                <div id="create-view-form" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                    <h4>Create New View</h4>
                    <div class="form-group">
                        <label>View Name</label>
                        <input type="text" id="new-view-name" placeholder="e.g., Paternal Line">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="new-view-description" rows="2" placeholder="Optional description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="new-view-default"> Set as default view
                        </label>
                    </div>
                    <div id="create-view-error" class="error-message"></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="cancelCreateView()" class="btn-secondary">Cancel</button>
                        <button onclick="createView()" class="btn-primary">Create</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tree Management Modal -->
    <div id="tree-management-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Family Trees</h3>
                <button onclick="closeTreeManagementModal()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="showCreateTreeForm()" class="btn-primary">
                        <i class="bi bi-plus-circle"></i> Create Empty Tree
                    </button>
                    <button onclick="saveCurrentTreeAs()" id="save-current-tree-btn" class="btn-primary" style="background: #28a745;">
                        <i class="bi bi-save"></i> Save Current as New Tree
                    </button>
                </div>

                <!-- Create Tree Form -->
                <div id="create-tree-form" style="display: none; margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background: #f8f9fa;">
                    <h4>Create New Tree</h4>
                    <div class="form-group">
                        <label>Tree Name *</label>
                        <input type="text" id="new-tree-name" placeholder="e.g., Maternal Line">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="new-tree-description" rows="2" placeholder="Optional description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="new-tree-default"> Set as default tree
                        </label>
                    </div>
                    <div id="create-tree-error" class="error-message"></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="cancelCreateTree()" class="btn-secondary">Cancel</button>
                        <button onclick="createTree()" class="btn-primary">Create</button>
                    </div>
                </div>

                <!-- Trees List -->
                <div id="trees-list" class="trees-list">
                    <p>Loading trees...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Shares Modal -->
    <div id="pending-shares-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pending Share Invitations</h3>
                <button onclick="closePendingSharesModal()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="pending-shares-list">
                    <p>Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Tree Modal -->
    <div id="share-tree-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share Tree</h3>
                <button onclick="closeShareTreeModal()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <form onsubmit="shareTree(event)">
                    <input type="hidden" id="share-tree-id">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="share-username" required placeholder="Enter username to share with">
                    </div>
                    <div class="form-group">
                        <label>Permission Level</label>
                        <select id="share-permission">
                            <option value="view">View Only</option>
                            <option value="edit">Can Edit</option>
                        </select>
                    </div>
                    <div id="share-error" class="error-message"></div>
                    <div class="form-actions">
                        <button type="button" onclick="closeShareTreeModal()" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Share</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Rename Tree Modal -->
    <div id="rename-tree-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Rename Tree</h3>
                <button onclick="closeRenameTreeModal()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <form onsubmit="renameTree(event)">
                    <div class="form-group">
                        <label>Tree Name *</label>
                        <input type="text" id="rename-tree-name" required placeholder="Enter new tree name">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="rename-tree-description" rows="2" placeholder="Optional description"></textarea>
                    </div>
                    <div id="rename-error" class="error-message"></div>
                    <div class="form-actions">
                        <button type="button" onclick="closeRenameTreeModal()" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5.3 JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- D3.js and other libraries -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- App JavaScript -->
    <script src="/static/app.js"></script>
</body>
</html>
